# Production compose (single domain behind reverse proxy + local Postgres)
# Usage:
# 1) Copy apps/api/.env.example -> set secrets in deploy environment (do NOT commit)
# 2) Set DOMAIN and ACME_EMAIL env vars on the host
# 3) docker compose -f docker-compose.prod.yml up -d --build

services:
  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN:-localhost}
      ACME_EMAIL: ${ACME_EMAIL:-devnull@example.com}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      web:
        condition: service_started
      api:
        condition: service_healthy

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: kargo
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me}
    volumes:
      - kargo-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d kargo"]
      interval: 5s
      timeout: 3s
      retries: 30

  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    env_file:
      - ./apps/api/.env
    environment:
      NODE_ENV: production
      PORT: 3001
      # Prefer local DB for predictable latency
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-change_me}@db:5432/kargo?schema=public
      DIRECT_URL: postgresql://postgres:${POSTGRES_PASSWORD:-change_me}@db:5432/kargo?schema=public
      OPTIMIZER_URL: http://optimizer:5000
      OSRM_URL: http://osrm:5000
      # Same-origin behind reverse proxy; set to your domain if you need CORS
      CORS_ORIGIN: https://${DOMAIN:-localhost}
      LOG_FORMAT: ${LOG_FORMAT:-pretty}
    command: sh -c "node_modules/.bin/prisma migrate deploy && node dist/main"
    healthcheck:
      test: ["CMD", "node", "-e", "const http=require('http');const r=http.request({hostname:'127.0.0.1',port:3001,path:'/api/health/ready',timeout:2000},res=>process.exit(res.statusCode===200?0:1));r.on('error',()=>process.exit(1));r.on('timeout',()=>process.exit(1));r.end();"]
      interval: 10s
      timeout: 3s
      retries: 20
    depends_on:
      db:
        condition: service_healthy
      optimizer:
        condition: service_healthy
      osrm:
        condition: service_healthy

  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      # Leave unset to use relative /api behind proxy
      NEXT_PUBLIC_API_URL: ""
    depends_on:
      api:
        condition: service_healthy

  optimizer:
    build:
      context: ./apps/optimizer
      dockerfile: Dockerfile
    environment:
      PORT: 5000
      OSRM_URL: http://osrm:5000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; urllib.request.urlopen('http://127.0.0.1:5000/health', timeout=2); sys.exit(0)"]
      interval: 10s
      timeout: 3s
      retries: 20

  osrm:
    image: osrm/osrm-backend:latest
    command: ["sh", "-c", "osrm-routed --algorithm mld ${OSRM_DATA:-/data/turkey-latest.osrm}"]
    volumes:
      - ./osrm-data:/data:ro
    healthcheck:
      test: ["CMD-SHELL", "test -s ${OSRM_DATA:-/data/turkey-latest.osrm}"]
      interval: 10s
      timeout: 3s
      retries: 20

volumes:
  kargo-db-data:
  caddy-data:
  caddy-config:
